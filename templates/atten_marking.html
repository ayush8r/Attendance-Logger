<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Marking</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='atten_marking.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
</head>

<body>

    <div class="sidebar">
        <div class="design">
            <h3>ATTENDANCE LOGGER</h3>
            <div class="section-1">
                <a href="{{ url_for('dashboard') }}" class="btn">Dashboard</a>
            </div>
            <div class="section-2">
                <a href="{{ url_for('registration') }}" class="btn">Student Registration</a>
            </div>
            <div class="section-3">
                <a href="{{ url_for('userupdate') }}" class="btn">Update info</a>
            </div>
            <div class="section-4">
                <a href="{{ url_for('attmarking') }}" class="btn">Attendance Marking</a>
            </div>
            <div class="section-5">
                <a href="{{ url_for('report') }}" class="btn">Attendance Report</a>
            </div>
            <div class="section-6">
                <a href="{{ url_for('contact') }}" class="btn">Contact Us</a>
            </div>
            <form method="post" action="{{ url_for('logout') }}">
                <button type="submit" class="btn">Logout</button>
            </form>
        </div>
    </div>
    <div class="main-content">
        <!-- This section will display any messages sent from the backend (e.g., "Attendance submitted successfully!") -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <h2>Mark Attendance</h2>
        <p class="text-muted">Attendance can only be marked once per day for each semester.</p>
        <hr>

        <!-- Step 1: Select Semester -->
        <div class="card p-3 mb-4 shadow-sm">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <label for="semester-select" class="form-label"><strong>Select Semester to Load:</strong></label>
                    <select id="semester-select" class="form-select">
                        <option selected disabled>Choose a semester...</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <button id="load-students" class="btn btn-primary mt-4">Load Students</button>
                </div>
            </div>
        </div>

        <!-- Step 2: Mark Attendance (This div will be populated by JavaScript) -->
        <div id="attendance-form-container">
            <!-- The dynamic attendance form will be injected here -->
        </div>

    </div>

    <!-- Bootstrap JS for alerts and other components -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Custom JavaScript for this page -->
    <script>
        // Wait for the document to be fully loaded before attaching event listeners
        document.addEventListener('DOMContentLoaded', function() {
        
            // Find the "Load Students" button
            const loadButton = document.getElementById('load-students');

            // Attach a click event listener to the button
            loadButton.addEventListener('click', async function () {
                const semesterSelect = document.getElementById('semester-select');
                const selectedSemester = semesterSelect.value;
                const formContainer = document.getElementById('attendance-form-container');

                // Clear any previous form or error messages from the container
                formContainer.innerHTML = '<div class="d-flex justify-content-center mt-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';

                // Validate that a semester has been chosen
                if (semesterSelect.selectedIndex === 0) {
                    formContainer.innerHTML = `<div class="alert alert-warning">Please select a semester first.</div>`;
                    return;
                }

                try {
                    // Fetch the list of students from the backend using the selected semester
                    const response = await fetch(`/get_students_by_semester/${selectedSemester}`);
                    const data = await response.json();

                    // If the server responds with an error (e.g., 404, 409), handle it
                    if (!response.ok) {
                        throw new Error(data.error || 'An unknown error occurred while fetching students.');
                    }
                    
                    // Start building the HTML for the attendance form
                    let formHTML = `
                        <form action="/submit_attendance" method="POST">
                            <div class="card shadow-sm">
                                <div class="card-header bg-dark text-white">
                                    <h4>Marking Attendance for Semester ${selectedSemester} - ${new Date().toLocaleDateString()}</h4>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th class="ps-4">Roll Number</th>
                                                    <th>Student Name</th>
                                                    <th class="text-center">Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                    `;

                    // Loop through each student returned from the server and create a table row
                    data.forEach(student => {
                        formHTML += `
                            <tr>
                                <td class="ps-4">${student.student_id}</td>
                                <td>${student.full_name}</td>
                                <td class="text-center">
                                    <!-- Using Bootstrap's button group for a modern toggle look -->
                                    <div class="btn-group" role="group" aria-label="Attendance status for ${student.full_name}">
                                        <input type="radio" class="btn-check" name="status_${student.id}" id="present_${student.id}" value="Present" autocomplete="off" required>
                                        <label class="btn btn-outline-success" for="present_${student.id}">Present</label>

                                        <input type="radio" class="btn-check" name="status_${student.id}" id="absent_${student.id}" value="Absent" autocomplete="off">
                                        <label class="btn btn-outline-danger" for="absent_${student.id}">Absent</label>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });

                    // Close the HTML tags and add a submit button
                    formHTML += `
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="card-footer text-end">
                                    <button type="submit" class="btn btn-lg btn-success">Submit Attendance</button>
                                </div>
                            </div>
                        </form>
                    `;

                    // Insert the complete, newly-built form into the page
                    formContainer.innerHTML = formHTML;

                } catch (error) {
                    // If any error occurred during the fetch, display it in an alert box
                    formContainer.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
                }
            });
        });
    </script>
</body>

</html>