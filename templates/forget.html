<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot Password</title>
    <!-- Link to the external CSS file -->
    <link rel="stylesheet" href="{{ url_for('static', filename='forget_style.css') }}">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
</head>
<body>
    <div class="container">
        <h2>Forgot Password</h2>
        <div id="message-area"></div> <!-- Message area will be styled by CSS -->

        <div id="email-section">
            <div class="input-group">
                <label for="email" class="label-hidden">Email :</label> <!-- Visually hidden but accessible label -->
                <div class="input-field-container"> <!-- Wrapper for input and button -->
                    <input type="email" id="email" placeholder="Enter your Registered Email">
                    <button class="action-button" onclick="sendOtp()">Send OTP</button> <!-- Using general action-button class -->
                </div>
            </div>
        </div>

        <div id="otp-section" class="hidden">
            <p class="subtitle">An OTP should have been sent to your email. Please check your inbox (and spam folder).</p>
            <div class="input-group">
                <label for="otp" class="label-hidden">OTP:</label> <!-- Visually hidden label -->
                <div class="input-field-container"> <!-- Wrapper for input and button -->
                    <input type="number" id="otp" placeholder="Enter 6-digit OTP" minlength="6" maxlength="6">
                    <button class="action-button" onclick="verifyOtp()">Verify OTP</button> <!-- Using general action-button class -->
                </div>
            </div>
        </div>
        
        <div id="password-section" class="hidden">
            <div class="input-group"> <!-- No 'full-width' needed if action-button is always 100% -->
                <label for="new_password">New Password:</label>
                <input type="password" id="new_password" placeholder="Enter Your new password">
            </div>
            <!-- Changed original .btn to .action-button for consistency -->
            <button type="button" class="action-button" onclick="resetPassword()">Change Password</button>
        </div>

        <div class="login-link-container">
            <a href="{{ url_for('login') }}" class="login-link">Back to Login</a>
        </div>
    </div>

    <script>
        // YOUR ENTIRE JAVASCRIPT CODE REMAINS UNCHANGED HERE
        // (Copy and paste your existing script block directly)

        let userEmailForReset = ''; // Store email globally for simplicity for this multi-step form

        function displayMessage(message, type) {
            const messageArea = document.getElementById('message-area');
            messageArea.innerHTML = `<div class="message ${type}">${message}</div>`;
            if (type === 'success' && message.includes('Redirecting')) {
                // Don't clear success message immediately if it's a redirect message
            } else {
                setTimeout(() => { 
                    if (messageArea.firstChild && messageArea.firstChild.classList.contains(type)) {
                        messageArea.innerHTML = ''; // Clear message after some time unless it's a redirect msg
                    }
                }, 5000); 
            }
        }

        function setLoadingState(button, isLoading) {
            if (isLoading) {
                button.disabled = true;
                button.dataset.originalText = button.textContent;
                button.textContent = 'Processing...';
            } else {
                button.disabled = false;
                if (button.dataset.originalText) {
                    button.textContent = button.dataset.originalText;
                }
            }
        }

        async function sendOtp() {
            const emailInput = document.getElementById('email');
            const email = emailInput.value.trim();
            const button = event.target;

            if (!email || !/^\S+@\S+\.\S+$/.test(email)) { // Basic email validation
                displayMessage('Please enter a valid email address.', 'error');
                return;
            }
            userEmailForReset = email; 
            setLoadingState(button, true);

            try {
                const response = await fetch('/send_otp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email })
                });
                const data = await response.json();
                if (response.ok) {
                    let successMsg = data.message;
                    // if (data.otp_dev_only) { // KEEP THIS COMMENTED OR REMOVED
                    //      successMsg += ` (Development OTP: ${data.otp_dev_only})`;
                    // }
                    displayMessage(successMsg, 'success');
                    document.getElementById('email-section').classList.add('hidden');
                    document.getElementById('otp-section').classList.remove('hidden');
                    document.getElementById('otp').focus();
                } else {
                    displayMessage(data.error || 'Failed to send OTP. Please try again.', 'error');
                }
            } catch (error) {
                displayMessage('An error occurred. Please check your connection and try again.', 'error');
                console.error('Send OTP error:', error);
            } finally {
                setLoadingState(button, false);
            }
        }

        async function verifyOtp() {
            const otpInput = document.getElementById('otp');
            const otp = otpInput.value.trim();
            const button = event.target;

            if (!otp || otp.length !== 6 || !/^\d{6}$/.test(otp)) {
                displayMessage('Please enter a valid 6-digit OTP.', 'error');
                return;
            }
            setLoadingState(button, true);

            try {
                const response = await fetch('/verify_otp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: userEmailForReset, otp: otp })
                });
                const data = await response.json();
                if (response.ok) {
                    displayMessage(data.message, 'success');
                    document.getElementById('otp-section').classList.add('hidden');
                    document.getElementById('password-section').classList.remove('hidden');
                    document.getElementById('new_password').focus();
                } else {
                    displayMessage(data.error || 'Failed to verify OTP. Please try again.', 'error');
                }
            } catch (error) {
                displayMessage('An error occurred. Please check your connection and try again.', 'error');
                console.error('Verify OTP error:', error);
            } finally {
                setLoadingState(button, false);
            }
        }

        async function resetPassword() {
            const passwordInput = document.getElementById('new_password');
            const newPassword = passwordInput.value;
            const button = event.target;

            if (!newPassword || newPassword.length < 6) { 
                displayMessage('Password must be at least 6 characters long.', 'error');
                return;
            }
            setLoadingState(button, true);

            try {
                const response = await fetch('/reset_password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: userEmailForReset, new_password: newPassword })
                });
                const data = await response.json();
                if (response.ok) {
                    displayMessage(data.message, 'success');
                    setTimeout(() => {
                        window.location.href = data.redirect_url;
                    }, 3000); // Wait 3 seconds before redirecting
                } else {
                    displayMessage(data.error || 'Failed to reset password. Please try again.', 'error');
                }
            } catch (error) {
                displayMessage('An error occurred. Please check your connection and try again.', 'error');
                console.error('Reset Password error:', error);
            } finally {
                // Don't reset loading state if redirecting, button will disappear
                if (document.getElementById('password-section') && !document.getElementById('password-section').classList.contains('hidden')) {
                     setLoadingState(button, false);
                }
            }
        }

        // Add event listener for Enter key on input fields
        document.getElementById('email').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent default form submission
                // Find the button within the same section to click
                this.closest('.input-group').querySelector('.action-button').click();
            }
        });
        document.getElementById('otp').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                this.closest('.input-group').querySelector('.action-button').click();
            }
        });
         document.getElementById('new_password').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                // Find the button associated with this section (it's outside the input-group)
                document.querySelector('#password-section .action-button').click();
            }
        });
    </script>
</body>
</html>